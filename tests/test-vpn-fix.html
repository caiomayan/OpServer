<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Correção da Detecção de VPN</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #444;
            margin-top: 30px;
        }
        .test-section {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
        }
        .ip-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .ip-test-item {
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Teste de Correção da Detecção de VPN</h1>
    
    <div class="test-section">
        <h2>1. Verificação de Configuração</h2>
        <button id="test-config" class="test-button">Verificar Configuração</button>
        <div id="config-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Teste da Função isPrivateNetworkIP</h2>
        <button id="test-ip-detection" class="test-button">Testar Detecção de IPs</button>
        <div id="ip-test-result" class="result"></div>
        <div id="ip-test-grid" class="ip-test-grid"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Teste de Servidor Configurado</h2>
        <button id="test-configured-server" class="test-button">Testar Servidor Configurado</button>
        <div id="server-test-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Teste de Fetch Completo</h2>
        <button id="test-fetch" class="test-button">Testar Fetch do Servidor</button>
        <div id="fetch-test-result" class="result"></div>
    </div>
    
    <div class="log-container" id="log"></div>

    <script type="module">
        import { SERVER_CONFIG } from '../src/server-config.js';
        
        // Referência para a instância do CS2ServerStatus
        let cs2ServerStatus;
        
        // Função para adicionar logs
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Função para mostrar resultado
        function showResult(elementId, message, status) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result ' + status;
        }
        
        // Teste 1: Verificar configuração
        document.getElementById('test-config').addEventListener('click', async function() {
            log('Iniciando teste de configuração...');
            
            try {
                // Verificar se a instância global existe
                if (window.cs2ServerStatus) {
                    cs2ServerStatus = window.cs2ServerStatus;
                    log('Instância global do CS2ServerStatus encontrada');
                } else {
                    log('Instância global não encontrada, aguardando importação...');
                    
                    try {
                        const module = await import('../src/cs2-server-status.js');
                        const CS2ServerStatus = module.default;
                        cs2ServerStatus = new CS2ServerStatus();
                        log('Módulo CS2ServerStatus importado e instanciado com sucesso');
                    } catch (error) {
                        throw new Error(`Erro ao importar módulo: ${error.message}`);
                    }
                }
                
                // Verificar se a configuração está carregada
                const config = cs2ServerStatus.config;
                
                log(`SERVER_IP configurado: ${config.SERVER_IP}`);
                log(`SERVER_PORT configurado: ${config.SERVER_PORT}`);
                log(`STEAM_API_KEY configurada: ${config.STEAM_API_KEY ? '✓ (presente)' : '✗ (ausente)'}`);
                
                showResult('config-result', 
                    `Configuração carregada com sucesso!\nIP: ${config.SERVER_IP}\nPorta: ${config.SERVER_PORT}`, 
                    'success');
                
            } catch (error) {
                log(`Erro no teste de configuração: ${error.message}`, 'error');
                showResult('config-result', `Erro: ${error.message}`, 'error');
            }
        });
        
        // Teste 2: Testar a função isPrivateNetworkIP
        document.getElementById('test-ip-detection').addEventListener('click', async function() {
            log('Iniciando teste de detecção de IPs privados...');
            
            try {
                if (!cs2ServerStatus) {
                    throw new Error('CS2ServerStatus não está inicializado. Execute o teste de configuração primeiro.');
                }
                
                // Lista de IPs para testar
                const ipsToTest = [
                    '10.0.0.1',         // Privado (10.0.0.0/8)
                    '172.16.0.1',       // Privado (172.16.0.0/12)
                    '192.168.1.1',      // Privado (192.168.0.0/16)
                    '127.0.0.1',        // Loopback
                    '8.8.8.8',          // Público (Google DNS)
                    '1.1.1.1',          // Público (Cloudflare DNS)
                    '177.54.147.46',    // Servidor configurado
                    '26.0.0.1'          // Começando com 26 (antigo caso problemático)
                ];
                
                const results = [];
                const grid = document.getElementById('ip-test-grid');
                grid.innerHTML = '';
                
                for (const ip of ipsToTest) {
                    const isPrivate = cs2ServerStatus.isPrivateNetworkIP(ip);
                    results.push(`${ip}: ${isPrivate ? 'Privado' : 'Público'}`);
                    
                    const item = document.createElement('div');
                    item.className = `ip-test-item ${isPrivate ? 'warning' : 'success'}`;
                    item.textContent = `${ip}: ${isPrivate ? 'Privado/VPN' : 'Público'}`;
                    grid.appendChild(item);
                    
                    log(`IP ${ip} detectado como: ${isPrivate ? 'Privado/VPN' : 'Público'}`);
                }
                
                // Verificar especificamente o IP do servidor configurado
                const configuredServerIP = cs2ServerStatus.config.SERVER_IP;
                const isConfiguredServerPrivate = cs2ServerStatus.isPrivateNetworkIP(configuredServerIP);
                
                if (isConfiguredServerPrivate) {
                    showResult('ip-test-result', 
                        `Atenção: O IP do servidor configurado (${configuredServerIP}) ainda está sendo detectado como privado/VPN!`, 
                        'warning');
                } else {
                    showResult('ip-test-result', 
                        `Sucesso: O IP do servidor configurado (${configuredServerIP}) está sendo detectado corretamente como público!`, 
                        'success');
                }
                
            } catch (error) {
                log(`Erro no teste de detecção de IPs: ${error.message}`, 'error');
                showResult('ip-test-result', `Erro: ${error.message}`, 'error');
            }
        });
        
        // Teste 3: Testar o servidor configurado
        document.getElementById('test-configured-server').addEventListener('click', async function() {
            log('Iniciando teste do servidor configurado...');
            
            try {
                if (!cs2ServerStatus) {
                    throw new Error('CS2ServerStatus não está inicializado. Execute o teste de configuração primeiro.');
                }
                
                const configuredServerIP = cs2ServerStatus.config.SERVER_IP;
                const isPrivate = cs2ServerStatus.isPrivateNetworkIP(configuredServerIP);
                
                log(`Servidor configurado (${configuredServerIP}) detectado como: ${isPrivate ? 'Privado/VPN' : 'Público'}`);
                
                if (isPrivate) {
                    // Se ainda estiver detectando como privado, verificar por que
                    const ipParts = configuredServerIP.split('.');
                    const firstOctet = parseInt(ipParts[0], 10);
                    const secondOctet = parseInt(ipParts[1], 10);
                    
                    let reason = 'Razão desconhecida';
                    
                    if (firstOctet === 10) {
                        reason = 'IP está na faixa 10.0.0.0/8 (privado)';
                    } else if (firstOctet === 172 && secondOctet >= 16 && secondOctet <= 31) {
                        reason = 'IP está na faixa 172.16.0.0/12 (privado)';
                    } else if (firstOctet === 192 && secondOctet === 168) {
                        reason = 'IP está na faixa 192.168.0.0/16 (privado)';
                    } else if (firstOctet === 127) {
                        reason = 'IP está na faixa de loopback 127.0.0.0/8';
                    } else if (firstOctet === 100 && secondOctet >= 64 && secondOctet <= 127) {
                        reason = 'IP está na faixa 100.64.0.0/10 (NAT Carrier-grade)';
                    }
                    
                    showResult('server-test-result', 
                        `Problema: O servidor (${configuredServerIP}) ainda está sendo detectado como privado/VPN.\nRazão: ${reason}`, 
                        'warning');
                } else {
                    showResult('server-test-result', 
                        `Sucesso: O servidor (${configuredServerIP}) está sendo detectado corretamente como público!`, 
                        'success');
                }
                
            } catch (error) {
                log(`Erro no teste do servidor configurado: ${error.message}`, 'error');
                showResult('server-test-result', `Erro: ${error.message}`, 'error');
            }
        });
        
        // Teste 4: Testar fetch completo
        document.getElementById('test-fetch').addEventListener('click', async function() {
            log('Iniciando teste de fetch completo do servidor...');
            
            try {
                if (!cs2ServerStatus) {
                    throw new Error('CS2ServerStatus não está inicializado. Execute o teste de configuração primeiro.');
                }
                
                log('Executando fetchServerData()...');
                const data = await cs2ServerStatus.fetchServerData();
                
                log(`Resultado do fetch: ${JSON.stringify(data, null, 2)}`);
                
                if (data.status === 'vpn') {
                    showResult('fetch-test-result', 
                        `Problema: O servidor ainda está sendo detectado como VPN.\nDados: ${JSON.stringify(data, null, 2)}`, 
                        'warning');
                } else {
                    showResult('fetch-test-result', 
                        `Sucesso: O servidor não está sendo detectado como VPN!\nStatus: ${data.status}\nDados: ${JSON.stringify(data, null, 2)}`, 
                        'success');
                }
                
            } catch (error) {
                log(`Erro no teste de fetch: ${error.message}`, 'error');
                showResult('fetch-test-result', `Erro: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
