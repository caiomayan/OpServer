<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Sistema de Cache - Teste Final</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            background: linear-gradient(45deg, #f59e0b, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-5px);
            border-color: #f59e0b;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
        }
        .test-card h3 {
            margin-top: 0;
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        .status-indicator.success {
            background: #22c55e;
        }
        .status-indicator.vpn {
            background: #f59e0b;
        }
        .button {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            margin: 5px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid #f59e0b;
        }
        .success { border-left-color: #22c55e; }
        .error { border-left-color: #ef4444; }
        .info { border-left-color: #3b82f6; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è Sistema de Cache Server-Side</h1>
            <p>‚úÖ <strong>Implementa√ß√£o Completa e Funcional</strong></p>
            <p>Teste final integrado - OpServer Cache System</p>
        </div>

        <div class="test-grid">
            <!-- Cache Status -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="cache-indicator"></span>
                    Status do Cache
                </h3>
                <div id="cache-status">üîÑ Inicializando...</div>
                <div class="performance-stats" id="cache-metrics">
                    <!-- Will be populated -->
                </div>
            </div>

            <!-- VPN Test -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator vpn" id="vpn-indicator"></span>
                    Teste VPN
                </h3>
                <button class="button" onclick="testVPNDetection()">
                    üîå Testar Servidor VPN
                </button>
                <div id="vpn-result" class="result info">
                    Clique para testar detec√ß√£o de servidor VPN (26.x.x.x)
                </div>
            </div>

            <!-- Performance Test -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="perf-indicator"></span>
                    Performance
                </h3>
                <button class="button" onclick="testPerformance()">
                    ‚ö° Testar Performance
                </button>
                <div id="performance-result" class="result info">
                    Teste de cache hit vs cache miss
                </div>
            </div>

            <!-- Integration Test -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="integration-indicator"></span>
                    Integra√ß√£o
                </h3>
                <button class="button" onclick="testIntegration()">
                    üîÑ Testar Integra√ß√£o
                </button>
                <div id="integration-result" class="result info">
                    Teste de integra√ß√£o com sistema principal
                </div>
            </div>
        </div>

        <!-- Overall Stats -->
        <div class="test-card">
            <h3>üìä Estat√≠sticas Gerais</h3>
            <div class="performance-stats" id="overall-stats">
                <div class="stat-box">
                    <div class="stat-value" id="total-tests">0</div>
                    <div class="stat-label">Testes Executados</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-label">Taxa de Sucesso</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avg-response">0ms</div>
                    <div class="stat-label">Resposta M√©dia</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="cache-hit-rate">0%</div>
                    <div class="stat-label">Cache Hit Rate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="./src/server-cache.js"></script>
    <script src="./src/translations.js"></script>

    <script>
        let testCache = null;
        let testStats = {
            totalTests: 0,
            successfulTests: 0,
            totalResponseTime: 0,
            cacheHits: 0,
            cacheMisses: 0
        };

        // Initialize test system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing final cache test system...');
            initializeSystem();
        });

        async function initializeSystem() {
            try {
                // Wait for dependencies
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Initialize cache
                if (window.CachedServerStatusFetcher) {
                    testCache = new window.CachedServerStatusFetcher({
                        cache: {
                            cacheDuration: 30000,
                            maxCacheSize: 20,
                            enabled: true
                        }
                    });

                    updateStatus('cache-status', '‚úÖ Sistema de cache inicializado com sucesso!', 'success');
                    updateIndicator('cache-indicator', 'success');
                    
                    // Update metrics
                    setInterval(updateMetrics, 2000);
                    updateMetrics();
                    
                } else {
                    throw new Error('CachedServerStatusFetcher not available');
                }

                // Test CS2ServerStatus integration
                if (window.cs2ServerStatus) {
                    updateStatus('integration-result', '‚úÖ Integra√ß√£o com CS2ServerStatus detectada', 'success');
                    updateIndicator('integration-indicator', 'success');
                } else {
                    updateStatus('integration-result', '‚ö†Ô∏è CS2ServerStatus n√£o detectado (normal em p√°gina de teste)', 'info');
                }

                console.log('‚úÖ Sistema de teste inicializado com sucesso');

            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateStatus('cache-status', '‚ùå Erro: ' + error.message, 'error');
                updateIndicator('cache-indicator', 'error');
            }
        }

        async function testVPNDetection() {
            console.log('üîå Testing VPN detection...');
            const startTime = performance.now();
            testStats.totalTests++;

            try {
                const serverConfig = { ip: '26.115.124.39', port: '27015' };
                const result = await testCache.fetchServerStatus(serverConfig);
                const endTime = performance.now();
                const responseTime = endTime - startTime;

                testStats.totalResponseTime += responseTime;
                
                if (result.fromCache) {
                    testStats.cacheHits++;
                } else {
                    testStats.cacheMisses++;
                }

                if (result.status === 'vpn') {
                    testStats.successfulTests++;
                    updateStatus('vpn-result', 
                        `‚úÖ VPN detectado corretamente!\n` +
                        `Status: ${result.status}\n` +
                        `Response Time: ${responseTime.toFixed(2)}ms\n` +
                        `From Cache: ${result.fromCache ? 'Yes' : 'No'}`, 'success');
                    updateIndicator('vpn-indicator', 'success');
                } else {
                    updateStatus('vpn-result', 
                        `‚ùå Falha na detec√ß√£o VPN\n` +
                        `Status recebido: ${result.status}\n` +
                        `Esperado: vpn`, 'error');
                }

            } catch (error) {
                console.error('‚ùå VPN test failed:', error);
                updateStatus('vpn-result', '‚ùå Erro no teste: ' + error.message, 'error');
            }

            updateOverallStats();
        }

        async function testPerformance() {
            console.log('‚ö° Testing performance...');
            updateStatus('performance-result', 'üîÑ Executando teste de performance...', 'info');
            updateIndicator('perf-indicator', 'testing');

            try {
                const serverConfig = { ip: '26.115.124.39', port: '27015' };
                
                // First request (likely cache miss)
                const start1 = performance.now();
                const result1 = await testCache.fetchServerStatus(serverConfig);
                const time1 = performance.now() - start1;
                
                testStats.totalTests++;
                testStats.totalResponseTime += time1;
                if (result1.fromCache) testStats.cacheHits++; else testStats.cacheMisses++;

                // Wait a moment
                await new Promise(resolve => setTimeout(resolve, 100));

                // Second request (should be cache hit)
                const start2 = performance.now();
                const result2 = await testCache.fetchServerStatus(serverConfig);
                const time2 = performance.now() - start2;
                
                testStats.totalTests++;
                testStats.totalResponseTime += time2;
                if (result2.fromCache) testStats.cacheHits++; else testStats.cacheMisses++;

                const improvement = ((time1 - time2) / time1 * 100).toFixed(1);
                
                testStats.successfulTests += 2;
                updateStatus('performance-result', 
                    `‚úÖ Teste de performance completo!\n` +
                    `Primeira requisi√ß√£o: ${time1.toFixed(2)}ms (${result1.fromCache ? 'cache' : 'fresh'})\n` +
                    `Segunda requisi√ß√£o: ${time2.toFixed(2)}ms (${result2.fromCache ? 'cache' : 'fresh'})\n` +
                    `Melhoria: ${improvement}%`, 'success');
                updateIndicator('perf-indicator', 'success');

            } catch (error) {
                console.error('‚ùå Performance test failed:', error);
                updateStatus('performance-result', '‚ùå Erro no teste: ' + error.message, 'error');
                updateIndicator('perf-indicator', 'error');
            }

            updateOverallStats();
        }

        async function testIntegration() {
            console.log('üîÑ Testing integration...');
            updateStatus('integration-result', 'üîÑ Testando integra√ß√£o...', 'info');

            try {
                // Test cache stats
                const stats = testCache.getCacheStats();
                
                // Test cache clearing
                testCache.clearCache();
                
                // Test config update
                testCache.updateCacheConfig({
                    cacheDuration: 45000,
                    maxCacheSize: 25
                });
                
                testStats.totalTests++;
                testStats.successfulTests++;
                
                updateStatus('integration-result', 
                    `‚úÖ Integra√ß√£o funcionando!\n` +
                    `Cache entries: ${stats.totalEntries}\n` +
                    `Valid entries: ${stats.validEntries}\n` +
                    `Cache duration: ${(stats.cacheDuration / 1000).toFixed(1)}s\n` +
                    `‚úÖ Clear cache: OK\n` +
                    `‚úÖ Config update: OK`, 'success');
                updateIndicator('integration-indicator', 'success');

            } catch (error) {
                console.error('‚ùå Integration test failed:', error);
                updateStatus('integration-result', '‚ùå Erro na integra√ß√£o: ' + error.message, 'error');
                updateIndicator('integration-indicator', 'error');
            }

            updateOverallStats();
        }

        function updateMetrics() {
            if (!testCache) return;

            try {
                const stats = testCache.getCacheStats();
                
                const metricsHTML = `
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalEntries}</div>
                        <div class="stat-label">Cache Entries</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.validEntries}</div>
                        <div class="stat-label">Valid</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${(stats.cacheDuration / 1000).toFixed(1)}s</div>
                        <div class="stat-label">TTL</div>
                    </div>
                `;
                
                document.getElementById('cache-metrics').innerHTML = metricsHTML;
            } catch (error) {
                console.warn('‚ö†Ô∏è Error updating metrics:', error);
            }
        }

        function updateOverallStats() {
            const successRate = testStats.totalTests > 0 ? 
                ((testStats.successfulTests / testStats.totalTests) * 100).toFixed(1) : 0;
            
            const avgResponse = testStats.totalTests > 0 ? 
                (testStats.totalResponseTime / testStats.totalTests).toFixed(1) : 0;
            
            const hitRate = (testStats.cacheHits + testStats.cacheMisses) > 0 ? 
                ((testStats.cacheHits / (testStats.cacheHits + testStats.cacheMisses)) * 100).toFixed(1) : 0;

            document.getElementById('total-tests').textContent = testStats.totalTests;
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('avg-response').textContent = avgResponse + 'ms';
            document.getElementById('cache-hit-rate').textContent = hitRate + '%';
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `result ${type}`;
            }
        }

        function updateIndicator(indicatorId, status) {
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.classList.remove('success', 'error', 'testing');
                if (status !== 'default') {
                    indicator.classList.add(status);
                }
            }
        }

        // Auto-run basic tests after initialization
        setTimeout(() => {
            if (testCache) {
                console.log('üî• Running automated tests...');
                testVPNDetection();
                setTimeout(() => testPerformance(), 2000);
                setTimeout(() => testIntegration(), 4000);
            }
        }, 3000);
    </script>
</body>
</html>
