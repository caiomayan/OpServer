<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o VPN Step-by-Step</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">üîç Valida√ß√£o VPN Step-by-Step</h1>
        
        <div class="space-y-6">
            <!-- Step 1: Sistema Carregado -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üìã Step 1: Verifica√ß√£o do Sistema</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">CS2ServerStatus</h4>
                        <div id="step1-cs2" class="text-sm">‚è≥ Verificando...</div>
                        <button id="test-step1" class="mt-2 bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm">Testar</button>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">Server Cache</h4>
                        <div id="step1-cache" class="text-sm">‚è≥ Verificando...</div>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">Configura√ß√£o IP</h4>
                        <div id="step1-config" class="text-sm">‚è≥ Verificando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Detec√ß√£o VPN -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üîå Step 2: Teste de Detec√ß√£o VPN</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">Fun√ß√£o isPrivateNetworkIP</h4>
                        <div id="step2-function" class="text-sm">‚è≥ Aguardando teste...</div>
                        <button id="test-step2" class="mt-2 bg-amber-500 hover:bg-amber-600 px-3 py-1 rounded text-sm">Testar Detec√ß√£o</button>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">Resultado</h4>
                        <div id="step2-result" class="text-sm">‚è≥ Aguardando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Fetch de Dados -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üì° Step 3: Fetch de Dados do Servidor</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">directFetchServerData()</h4>
                        <div id="step3-direct" class="text-sm">‚è≥ Aguardando teste...</div>
                        <button id="test-step3-direct" class="mt-2 bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">Teste Direto</button>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">fetchServerData() (com cache)</h4>
                        <div id="step3-cached" class="text-sm">‚è≥ Aguardando teste...</div>
                        <button id="test-step3-cached" class="mt-2 bg-purple-500 hover:bg-purple-600 px-3 py-1 rounded text-sm">Teste com Cache</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Formata√ß√£o de Dados -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üîß Step 4: Formata√ß√£o e Processamento</h2>
                <div class="bg-gray-700 rounded p-4">
                    <h4 class="font-medium mb-2">formatServerData()</h4>
                    <div id="step4-format" class="text-sm">‚è≥ Aguardando dados...</div>
                    <button id="test-step4" class="mt-2 bg-indigo-500 hover:bg-indigo-600 px-3 py-1 rounded text-sm">Testar Formata√ß√£o</button>
                </div>
            </div>
            
            <!-- Step 5: Update de UI -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üé® Step 5: Atualiza√ß√£o da Interface</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">updateVpnIndicators()</h4>
                        <div id="step5-indicators" class="text-sm">‚è≥ Aguardando...</div>
                        <button id="test-step5" class="mt-2 bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Testar Update</button>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-medium mb-2">Indicadores Visuais</h4>
                        
                        <!-- Test indicators -->
                        <div id="test-main-vpn-indicator" class="mt-2 flex items-center justify-center space-x-1 text-xs text-amber-500 opacity-0 transition-opacity duration-300" style="display: none;">
                            <span>üîå</span>
                            <span>Main VPN</span>
                        </div>
                        
                        <div id="test-vpn-indicator" class="mt-2 flex items-center space-x-2 p-2 bg-amber-500/10 border border-amber-500/20 rounded text-xs" style="display: none;">
                            <span>üîå</span>
                            <span>Server VPN</span>
                        </div>
                        
                        <div id="step5-visual" class="text-sm mt-2">‚è≥ Aguardando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 6: Teste Integrado -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üöÄ Step 6: Teste Integrado Completo</h2>
                <div class="text-center">
                    <button id="test-full-flow" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-8 py-3 rounded-lg text-lg font-semibold">
                        Executar Fluxo Completo
                    </button>
                    <div id="step6-result" class="mt-4 text-sm">‚è≥ Clique no bot√£o para iniciar teste completo</div>
                </div>
            </div>
        </div>
        
        <!-- Log detalhado -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">üìã Log Detalhado</h2>
            <div id="detailed-log" class="bg-black rounded p-4 font-mono text-xs text-green-400 h-64 overflow-y-auto whitespace-pre-wrap"></div>
            <button id="clear-detailed-log" class="mt-2 bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm">Limpar Log</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./src/server-cache.js"></script>
    <script type="module" src="./src/cs2-server-status.js"></script>
    
    <script>
        let detailedLog = [];
        
        function logDetail(message, step = '', level = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${step ? `${step} ` : ''}${level}: ${message}`;
            detailedLog.push(logEntry);
            
            const logElement = document.getElementById('detailed-log');
            logElement.textContent = detailedLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function updateStatus(elementId, status, isSuccess = null) {
            const element = document.getElementById(elementId);
            if (element) {
                if (isSuccess === true) {
                    element.innerHTML = `<span class="text-green-400">‚úÖ ${status}</span>`;
                } else if (isSuccess === false) {
                    element.innerHTML = `<span class="text-red-400">‚ùå ${status}</span>`;
                } else {
                    element.innerHTML = `<span class="text-yellow-400">‚ö†Ô∏è ${status}</span>`;
                }
            }
        }
        
        // Step 1: Verificar sistema
        document.getElementById('test-step1').addEventListener('click', () => {
            logDetail('Verificando sistemas carregados...', 'STEP1');
            
            // Check CS2ServerStatus
            if (window.cs2ServerStatus) {
                updateStatus('step1-cs2', 'Carregado', true);
                logDetail('CS2ServerStatus encontrado', 'STEP1', 'SUCCESS');
                
                // Check config
                const config = window.cs2ServerStatus.config;
                if (config && config.SERVER_IP) {
                    updateStatus('step1-config', `IP: ${config.SERVER_IP}`, true);
                    logDetail(`Configura√ß√£o IP: ${config.SERVER_IP}`, 'STEP1', 'SUCCESS');
                } else {
                    updateStatus('step1-config', 'Configura√ß√£o n√£o encontrada', false);
                    logDetail('Configura√ß√£o IP n√£o encontrada', 'STEP1', 'ERROR');
                }
            } else {
                updateStatus('step1-cs2', 'N√£o carregado', false);
                logDetail('CS2ServerStatus n√£o encontrado', 'STEP1', 'ERROR');
            }
            
            // Check cache
            if (window.globalServerCache || window.CachedServerStatusFetcher) {
                updateStatus('step1-cache', 'Dispon√≠vel', true);
                logDetail('Sistema de cache encontrado', 'STEP1', 'SUCCESS');
            } else {
                updateStatus('step1-cache', 'N√£o dispon√≠vel', false);
                logDetail('Sistema de cache n√£o encontrado', 'STEP1', 'WARNING');
            }
        });
        
        // Step 2: Testar detec√ß√£o VPN
        document.getElementById('test-step2').addEventListener('click', () => {
            logDetail('Testando detec√ß√£o VPN...', 'STEP2');
            
            if (!window.cs2ServerStatus) {
                updateStatus('step2-function', 'Sistema n√£o dispon√≠vel', false);
                updateStatus('step2-result', 'Falhou', false);
                logDetail('CS2ServerStatus n√£o dispon√≠vel para teste', 'STEP2', 'ERROR');
                return;
            }
            
            try {
                const testIPs = ['26.115.124.39', '192.168.1.1', '8.8.8.8'];
                let results = [];
                
                testIPs.forEach(ip => {
                    const isVPN = window.cs2ServerStatus.isPrivateNetworkIP(ip);
                    results.push(`${ip}: ${isVPN ? 'VPN' : 'P√∫blico'}`);
                    logDetail(`IP ${ip} detectado como: ${isVPN ? 'VPN' : 'P√∫blico'}`, 'STEP2');
                });
                
                updateStatus('step2-function', 'Funcionando', true);
                updateStatus('step2-result', results.join(', '), true);
                logDetail('Detec√ß√£o VPN funcionando corretamente', 'STEP2', 'SUCCESS');
                
            } catch (error) {
                updateStatus('step2-function', 'Erro na fun√ß√£o', false);
                updateStatus('step2-result', error.message, false);
                logDetail(`Erro na detec√ß√£o VPN: ${error.message}`, 'STEP2', 'ERROR');
            }
        });
        
        // Step 3: Testar fetch direto
        document.getElementById('test-step3-direct').addEventListener('click', async () => {
            logDetail('Testando fetch direto...', 'STEP3');
            
            if (!window.cs2ServerStatus) {
                updateStatus('step3-direct', 'Sistema n√£o dispon√≠vel', false);
                logDetail('CS2ServerStatus n√£o dispon√≠vel', 'STEP3', 'ERROR');
                return;
            }
            
            try {
                const data = await window.cs2ServerStatus.directFetchServerData();
                updateStatus('step3-direct', `Status: ${data.status}`, data.status === 'vpn');
                logDetail(`Fetch direto retornou: ${JSON.stringify(data)}`, 'STEP3', data.status === 'vpn' ? 'SUCCESS' : 'INFO');
            } catch (error) {
                updateStatus('step3-direct', 'Erro no fetch', false);
                logDetail(`Erro no fetch direto: ${error.message}`, 'STEP3', 'ERROR');
            }
        });
        
        // Step 3: Testar fetch com cache
        document.getElementById('test-step3-cached').addEventListener('click', async () => {
            logDetail('Testando fetch com cache...', 'STEP3');
            
            if (!window.cs2ServerStatus) {
                updateStatus('step3-cached', 'Sistema n√£o dispon√≠vel', false);
                logDetail('CS2ServerStatus n√£o dispon√≠vel', 'STEP3', 'ERROR');
                return;
            }
            
            try {
                const data = await window.cs2ServerStatus.fetchServerData();
                updateStatus('step3-cached', `Status: ${data.status}`, data.status === 'vpn');
                logDetail(`Fetch com cache retornou: ${JSON.stringify(data)}`, 'STEP3', data.status === 'vpn' ? 'SUCCESS' : 'INFO');
            } catch (error) {
                updateStatus('step3-cached', 'Erro no fetch', false);
                logDetail(`Erro no fetch com cache: ${error.message}`, 'STEP3', 'ERROR');
            }
        });
        
        // Step 4: Testar formata√ß√£o
        document.getElementById('test-step4').addEventListener('click', () => {
            logDetail('Testando formata√ß√£o de dados...', 'STEP4');
            
            if (!window.cs2ServerStatus) {
                updateStatus('step4-format', 'Sistema n√£o dispon√≠vel', false);
                logDetail('CS2ServerStatus n√£o dispon√≠vel', 'STEP4', 'ERROR');
                return;
            }
            
            try {
                // Test with VPN data
                const testData = {
                    status: 'vpn',
                    name: 'Test VPN Server',
                    players: { current: 0, max: 32 },
                    map: '?'
                };
                
                const formatted = window.cs2ServerStatus.formatServerData(testData);
                updateStatus('step4-format', `Formatado: ${formatted.status}`, formatted.status === 'vpn');
                logDetail(`Dados formatados: ${JSON.stringify(formatted)}`, 'STEP4', formatted.status === 'vpn' ? 'SUCCESS' : 'WARNING');
            } catch (error) {
                updateStatus('step4-format', 'Erro na formata√ß√£o', false);
                logDetail(`Erro na formata√ß√£o: ${error.message}`, 'STEP4', 'ERROR');
            }
        });
        
        // Step 5: Testar update de indicadores
        document.getElementById('test-step5').addEventListener('click', () => {
            logDetail('Testando update de indicadores VPN...', 'STEP5');
            
            if (!window.cs2ServerStatus) {
                updateStatus('step5-indicators', 'Sistema n√£o dispon√≠vel', false);
                logDetail('CS2ServerStatus n√£o dispon√≠vel', 'STEP5', 'ERROR');
                return;
            }
            
            try {
                const vpnData = {
                    status: 'vpn',
                    name: 'Test VPN Server',
                    isVpnServer: true
                };
                
                // Rename our test indicators to match the function
                const mainIndicator = document.getElementById('test-main-vpn-indicator');
                const serverIndicator = document.getElementById('test-vpn-indicator');
                
                // Temporarily change IDs for testing
                if (mainIndicator) mainIndicator.id = 'main-vpn-indicator';
                if (serverIndicator) serverIndicator.id = 'vpn-indicator';
                
                window.cs2ServerStatus.updateVpnIndicators(vpnData);
                
                // Check if indicators are visible
                const mainVisible = mainIndicator && mainIndicator.style.display === 'flex';
                const serverVisible = serverIndicator && serverIndicator.style.display === 'flex';
                
                updateStatus('step5-indicators', `Main: ${mainVisible ? 'Vis√≠vel' : 'Oculto'}, Server: ${serverVisible ? 'Vis√≠vel' : 'Oculto'}`, mainVisible || serverVisible);
                updateStatus('step5-visual', `Indicadores ${mainVisible || serverVisible ? 'ativados' : 'n√£o ativados'}`, mainVisible || serverVisible);
                
                logDetail(`Indicadores - Main: ${mainVisible}, Server: ${serverVisible}`, 'STEP5', mainVisible || serverVisible ? 'SUCCESS' : 'WARNING');
                
                // Restore IDs
                if (mainIndicator) mainIndicator.id = 'test-main-vpn-indicator';
                if (serverIndicator) serverIndicator.id = 'test-vpn-indicator';
                
            } catch (error) {
                updateStatus('step5-indicators', 'Erro no update', false);
                updateStatus('step5-visual', 'Falhou', false);
                logDetail(`Erro no update de indicadores: ${error.message}`, 'STEP5', 'ERROR');
            }
        });
        
        // Step 6: Teste completo
        document.getElementById('test-full-flow').addEventListener('click', async () => {
            logDetail('=== INICIANDO TESTE COMPLETO ===', 'STEP6');
            updateStatus('step6-result', 'Executando...', null);
            
            try {
                if (!window.cs2ServerStatus) {
                    throw new Error('CS2ServerStatus n√£o dispon√≠vel');
                }
                
                // 1. Verificar detec√ß√£o VPN
                const isVPN = window.cs2ServerStatus.isPrivateNetworkIP('26.115.124.39');
                logDetail(`1. Detec√ß√£o VPN: ${isVPN}`, 'STEP6');
                
                if (!isVPN) {
                    throw new Error('Detec√ß√£o VPN falhou');
                }
                
                // 2. Fetch dados
                const data = await window.cs2ServerStatus.fetchServerData();
                logDetail(`2. Dados recebidos: ${data.status}`, 'STEP6');
                
                if (data.status !== 'vpn') {
                    throw new Error(`Status esperado 'vpn', recebido '${data.status}'`);
                }
                
                // 3. Update UI
                window.cs2ServerStatus.updateUI(data);
                logDetail('3. UI atualizada', 'STEP6');
                
                // 4. Verificar indicadores
                const mainIndicator = document.getElementById('main-vpn-indicator');
                const serverIndicator = document.getElementById('vpn-indicator');
                
                const mainVisible = mainIndicator && mainIndicator.style.display === 'flex';
                const serverVisible = serverIndicator && serverIndicator.style.display === 'flex';
                
                logDetail(`4. Indicadores - Main: ${mainVisible}, Server: ${serverVisible}`, 'STEP6');
                
                if (mainVisible || serverVisible) {
                    updateStatus('step6-result', 'SUCESSO! VPN detectado e indicadores ativados', true);
                    logDetail('=== TESTE COMPLETO: SUCESSO ===', 'STEP6', 'SUCCESS');
                } else {
                    updateStatus('step6-result', 'Parcial: VPN detectado mas indicadores n√£o ativados', null);
                    logDetail('=== TESTE COMPLETO: PARCIAL ===', 'STEP6', 'WARNING');
                }
                
            } catch (error) {
                updateStatus('step6-result', `FALHOU: ${error.message}`, false);
                logDetail(`=== TESTE COMPLETO: FALHOU - ${error.message} ===`, 'STEP6', 'ERROR');
            }
        });
        
        document.getElementById('clear-detailed-log').addEventListener('click', () => {
            detailedLog = [];
            document.getElementById('detailed-log').textContent = '';
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            logDetail('Sistema de valida√ß√£o inicializado');
            
            // Auto-run step 1 after a delay
            setTimeout(() => {
                document.getElementById('test-step1').click();
            }, 1000);
        });
    </script>
</body>
</html>
