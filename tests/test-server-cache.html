<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema de Cache - OpServer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #f59e0b;
            margin-top: 0;
        }
        .button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #1e40af;
        }
        .button.secondary {
            background: #6b7280;
        }
        .button.secondary:hover {
            background: #4b5563;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .status.success {
            background: #065f46;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
        }
        .status.info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
        }
        .status.vpn {
            background: #92400e;
            border: 1px solid #f59e0b;
        }
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #262626;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #f59e0b;
        }
        .stat-label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è Sistema de Cache Server-Side</h1>
            <p>Teste de funcionalidades do cache para status de servidores CS2</p>
        </div>

        <!-- Cache Status -->
        <div class="test-section">
            <h3>üìä Status do Cache</h3>
            <div id="cache-status" class="status info">
                üîÑ Inicializando sistema de cache...
            </div>
            <div class="stats-grid" id="cache-stats">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Server Tests -->
        <div class="test-section">
            <h3>üñ•Ô∏è Testes de Servidor</h3>
            <div>
                <button class="button" onclick="testVPNServer()">Testar Servidor VPN (26.x.x.x)</button>
                <button class="button" onclick="testPublicServer()">Testar Servidor P√∫blico</button>
                <button class="button" onclick="testCacheHit()">Testar Cache Hit</button>
                <button class="button secondary" onclick="clearCache()">Limpar Cache</button>
            </div>
            <div id="server-test-results"></div>
        </div>

        <!-- Cache Configuration -->
        <div class="test-section">
            <h3>‚öôÔ∏è Configura√ß√£o do Cache</h3>
            <div>
                <label>Dura√ß√£o do Cache (ms): 
                    <input type="number" id="cache-duration" value="30000" min="1000" max="300000">
                </label>
                <label>Tamanho M√°ximo: 
                    <input type="number" id="cache-size" value="50" min="5" max="200">
                </label>
                <button class="button" onclick="updateCacheConfig()">Atualizar Configura√ß√£o</button>
            </div>
        </div>

        <!-- Performance Monitor -->
        <div class="test-section">
            <h3>‚ö° Monitor de Performance</h3>
            <div id="performance-stats" class="stats-grid">
                <!-- Performance stats -->
            </div>
        </div>

        <!-- Debug Log -->
        <div class="test-section">
            <h3>üêõ Log de Debug</h3>
            <button class="button secondary" onclick="clearLog()">Limpar Log</button>
            <div id="debug-log" class="log">Aguardando testes...</div>
        </div>
    </div>

    <!-- Load Cache System -->
    <script src="./src/server-cache.js"></script>

    <script>
        // Test System Variables
        let testCache = null;
        let testStartTime = 0;
        let totalRequests = 0;
        let cacheHits = 0;
        let cacheMisses = 0;

        // Initialize Test System
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando sistema de teste de cache...');
            initializeCache();
            updateStats();
            setInterval(updateStats, 2000); // Update stats every 2 seconds
        });

        function initializeCache() {
            try {
                if (window.CachedServerStatusFetcher) {
                    testCache = new window.CachedServerStatusFetcher({
                        cache: {
                            cacheDuration: 30000,
                            maxCacheSize: 50,
                            enabled: true
                        },
                        retryAttempts: 2,
                        retryDelay: 1000
                    });
                    
                    updateStatus('‚úÖ Sistema de cache inicializado com sucesso!', 'success');
                    log('‚úÖ Cache system initialized successfully');
                } else {
                    throw new Error('CachedServerStatusFetcher not available');
                }
            } catch (error) {
                updateStatus('‚ùå Erro ao inicializar cache: ' + error.message, 'error');
                log('‚ùå Cache initialization failed: ' + error.message);
            }
        }

        async function testVPNServer() {
            if (!testCache) {
                updateStatus('‚ùå Cache n√£o inicializado', 'error');
                return;
            }

            log('üîç Testing VPN server (26.115.124.39:27015)...');
            const startTime = performance.now();
            totalRequests++;

            try {
                const serverConfig = {
                    ip: '26.115.124.39',
                    port: '27015'
                };

                const result = await testCache.fetchServerStatus(serverConfig);
                const endTime = performance.now();
                const duration = endTime - startTime;

                if (result.fromCache) {
                    cacheHits++;
                } else {
                    cacheMisses++;
                }

                displayServerResult('VPN Server Test', result, duration);
                log(`‚úÖ VPN server test completed in ${duration.toFixed(2)}ms`);
                log(`üìä Result: ${JSON.stringify(result, null, 2)}`);

            } catch (error) {
                log('‚ùå VPN server test failed: ' + error.message);
                updateStatus('‚ùå Teste VPN falhou: ' + error.message, 'error');
            }
        }

        async function testPublicServer() {
            if (!testCache) {
                updateStatus('‚ùå Cache n√£o inicializado', 'error');
                return;
            }

            log('üîç Testing public server (example IP)...');
            const startTime = performance.now();
            totalRequests++;

            try {
                const serverConfig = {
                    ip: '192.168.1.100', // Mock public IP
                    port: '27015'
                };

                const result = await testCache.fetchServerStatus(serverConfig);
                const endTime = performance.now();
                const duration = endTime - startTime;

                if (result.fromCache) {
                    cacheHits++;
                } else {
                    cacheMisses++;
                }

                displayServerResult('Public Server Test', result, duration);
                log(`‚úÖ Public server test completed in ${duration.toFixed(2)}ms`);

            } catch (error) {
                log('‚ùå Public server test failed: ' + error.message);
                updateStatus('‚ùå Teste servidor p√∫blico falhou: ' + error.message, 'error');
            }
        }

        async function testCacheHit() {
            if (!testCache) {
                updateStatus('‚ùå Cache n√£o inicializado', 'error');
                return;
            }

            log('üéØ Testing cache hit with repeated request...');
            
            // First request (should be fresh)
            await testVPNServer();
            
            // Wait a moment
            setTimeout(async () => {
                // Second request (should be from cache)
                await testVPNServer();
                log('üéØ Cache hit test completed');
            }, 500);
        }

        function clearCache() {
            if (!testCache) {
                updateStatus('‚ùå Cache n√£o inicializado', 'error');
                return;
            }

            testCache.clearCache();
            log('üßπ Cache cleared');
            updateStatus('üßπ Cache limpo com sucesso', 'info');
            updateStats();
        }

        function updateCacheConfig() {
            if (!testCache) {
                updateStatus('‚ùå Cache n√£o inicializado', 'error');
                return;
            }

            const duration = parseInt(document.getElementById('cache-duration').value);
            const size = parseInt(document.getElementById('cache-size').value);

            testCache.updateCacheConfig({
                cacheDuration: duration,
                maxCacheSize: size
            });

            log(`‚öôÔ∏è Cache config updated: duration=${duration}ms, maxSize=${size}`);
            updateStatus('‚öôÔ∏è Configura√ß√£o do cache atualizada', 'info');
            updateStats();
        }

        function displayServerResult(testName, result, duration) {
            const resultsDiv = document.getElementById('server-test-results');
            const statusClass = result.status === 'vpn' ? 'vpn' : 
                               result.status === 'online' ? 'success' : 
                               result.status === 'offline' ? 'error' : 'info';

            const resultHtml = `
                <div class="status ${statusClass}">
                    <strong>${testName}</strong><br>
                    Status: ${result.status.toUpperCase()}<br>
                    IP: ${result.ip}:${result.port}<br>
                    Duration: ${duration.toFixed(2)}ms<br>
                    From Cache: ${result.fromCache ? 'YES' : 'NO'}<br>
                    Players: ${result.players || 0}/${result.maxPlayers || 32}
                </div>
            `;

            resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
        }

        function updateStats() {
            if (!testCache) return;

            try {
                const stats = testCache.getCacheStats();
                
                const cacheStatsHtml = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalEntries}</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.validEntries}</div>
                        <div class="stat-label">Valid Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.expiredEntries}</div>
                        <div class="stat-label">Expired Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(stats.cacheDuration / 1000).toFixed(1)}s</div>
                        <div class="stat-label">Cache Duration</div>
                    </div>
                `;

                document.getElementById('cache-stats').innerHTML = cacheStatsHtml;

                const hitRate = totalRequests > 0 ? ((cacheHits / totalRequests) * 100).toFixed(1) : 0;

                const performanceHtml = `
                    <div class="stat-card">
                        <div class="stat-value">${totalRequests}</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${cacheHits}</div>
                        <div class="stat-label">Cache Hits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${cacheMisses}</div>
                        <div class="stat-label">Cache Misses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${hitRate}%</div>
                        <div class="stat-label">Hit Rate</div>
                    </div>
                `;

                document.getElementById('performance-stats').innerHTML = performanceHtml;

            } catch (error) {
                log('‚ö†Ô∏è Error updating stats: ' + error.message);
            }
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('cache-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = 'Log cleared...\n';
        }
    </script>
</body>
</html>
